<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SpeegoCycle - Book a Service</title>
    <link rel="stylesheet" href="userbookservice.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="#" class="back-arrow">
                <i class="ph ph-caret-left"></i>
            </a>
        </div>
        <div class="header-right">
            <a href="userservicehistory.html" class="nav-link">Service History</a>
            <a href="usertrack.html" class="nav-link">Track Service Requests</a>
            <a href="index.html" class="home-icon">
                <i class="ph ph-house"></i>
            </a>
            <span class="menu-icon" id="menuToggle">
                <i class="ph ph-list"></i>
            </span>
        </div>
    </header>

    <div class="search-container">
        <div class="search-box">
            <span class="search-icon"><i class="ph ph-magnifying-glass"></i></span>
            <input type="text" class="search-input" placeholder="Search">
            <span class="filter-icon"><i class="ph ph-funnel-simple"></i></span>
        </div>
    </div>

    <main class="main-content">
        <h1 class="page-title">Book a Service</h1>
        <div class="breadcrumb">Home <span>›</span> Services <span>›</span> Book a Service</div>

        <div class="booking-container">
            <section class="service-selection">
                <h2 class="section-title">Select a Service</h2>
                <div class="service-buttons">
                    <button class="service-btn active" data-service="repair">Repair</button>
                    <button class="service-btn" data-service="battery">Battery Replacement</button>
                    <button class="service-btn" data-service="parts">Parts Installation</button>
                </div>
            </section>

            <div class="ebike-details">
                <h3 class="section-title">E-Bike Details</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="product_name">Product Name</label>
                        <input type="text" id="product_name" name="product_name" class="form-input" placeholder="Enter e-bike name" required>
                    </div>

                    <div class="form-group">
                        <label for="serial_code">Serial Code</label>
                        <input type="text" id="serial_code" name="serial_code" class="form-input" placeholder="Enter your Serial Code" required>
                    </div>

                    <div class="form-group date-input-wrapper">
                        <label for="purchase_date">Purchase Date</label>
                        <input type="date" id="purchase_date" name="purchase_date" class="form-input" required>
                        <i class="fa-solid fa-calendar-days date-icon"></i>
                    </div>
                </div>
            </div>

            <section class="problem-section">
                <div class="form-group full-width">
                    <label for="problemDescription">PROBLEM DESCRIPTION</label>
                    <textarea id="problemDescription" class="form-textarea" placeholder="Enter an issue"></textarea>
                </div>
            </section>

            <section class="diagnosis-cost-section">
                <div class="left-section">
                    <!-- big diagnosis card — preserved style -->
                    <button class="smart-diagnosis-btn" id="smartDiagnosisBtn">
                        <i class="ph ph-first-aid-kit diagnosis-icon"></i>
                        <span class="diagnosis-title">Smart Diagnosis</span>
                        <div id="diagnosisResult" class="diagnosis-result" aria-live="polite"></div>
                    </button>
                </div>

                <div class="right-section">
                    <div class="cost-time-box">
                        <label>ESTIMATED REPAIR COST</label>
                        <div class="display-box" id="costBox">
                            <span class="peso-symbol">₱</span>
                            <span id="estimatedCost">--</span>
                        </div>
                    </div>
                    <div class="cost-time-box">
                        <label>ESTIMATED REPAIR TIME</label>
                        <div class="display-box" id="timeBox">
                            <i class="ph ph-timer"></i>
                            <span id="estimatedTime" style="margin-left:10px">--</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="appointment-section">
                <button class="smart-sched-btn" id="smartSchedBtn">
                    <i class="ph ph-calendar-check"></i>
                    Schedule an appointment
                </button>
                <button class="confirm-btn" id="confirmBtn">Confirm Appointment</button>
            </section>

            <div id="chosenSlotDisplay" style="text-align:center; margin-top:12px; font-weight:600; color:#333;"></div>
        </div>
    </main>

    <div class="sidebar" id="sidebar">
        <a href="shoppingcart.html" class="sidebar-item">Shopping Cart</a>
        <a href="orderhistory.html" class="sidebar-item">Order History</a>
        <a href="aboutus.html" class="sidebar-item">About Us</a>
        <a href="userservices.html" class="sidebar-item">Services</a>
        <a href="logout.html" class="sidebar-item">Log Out</a>
    </div>

    <!-- Modal: Smart Schedule -->
    <div id="scheduleModal" class="modal" aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="scheduleTitle">
        <h3 id="scheduleTitle">Select Your Preferred Slot</h3>
        <div id="slotList" class="slot-list"></div>
        <div class="modal-actions">
          <button id="confirmSlotBtn" class="confirm-btn" style="padding:10px 20px; border-radius:10px;">Confirm Slot</button>
          <button id="closeModalBtn" class="cancel-btn">Cancel</button>
        </div>
      </div>
    </div>

    <script>
    // Sidebar toggle
    document.getElementById('menuToggle').addEventListener('click', function(e){
        e.stopPropagation();
        document.getElementById('sidebar').classList.toggle('active');
    });

    // close sidebar clicking outside
    document.addEventListener('click', function(e){
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) sidebar.classList.remove('active');
    });

    // Service selection
    const serviceButtons = document.querySelectorAll('.service-btn');
    serviceButtons.forEach(btn => {
        btn.addEventListener('click', function () {
            serviceButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Keep track of the created service_request id (set by /diagnose response)
    let currentServiceRequestID = null;
    let selectedSlot = null;

    // Smart Diagnosis: call your Ollama-backed Flask endpoint
    document.getElementById('smartDiagnosisBtn').addEventListener('click', async function () {
        const problem = document.getElementById('problemDescription').value.trim();
        const productName = document.getElementById('product_name').value;
        const serial = document.getElementById('serial_code').value;
        const purchaseDate = document.getElementById('purchase_date').value;

        const resultBox = document.getElementById('diagnosisResult');
        const costBox = document.getElementById('estimatedCost');
        const timeBox = document.getElementById('estimatedTime');

        if (!problem) {
            alert('Please enter a problem description first.');
            return;
        }

        // show loader
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<em>Analyzing issue...</em>`;
        costBox.textContent = '--';
        timeBox.textContent = '--';

        try {
            const resp = await fetch('http://127.0.0.1:5000/diagnose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    description: problem,
                    product_id: serial || null,  // using serial as product_id
                    purchase_date: purchaseDate || null
                })
            });

            if (!resp.ok) throw new Error('Server error');

            const data = await resp.json();

            // show results and keep service_request_id for scheduling
            resultBox.innerHTML = `<strong>Diagnosis:</strong> ${data.diagnosis || '—'}`;
            
            // Handle cost display
            const costStr = (data.cost || '--').toString().replace('FREE', 'FREE').replace('₱', '').replace('PHP', '').trim();
            costBox.textContent = (data.cost && data.cost.toString().toUpperCase().includes('FREE')) ? 'FREE' : (costStr || '--');
            timeBox.textContent = data.time || '--';

            currentServiceRequestID = data.service_request_id || null;

        } catch (err) {
            console.error('Diagnosis error:', err);
            resultBox.innerHTML = `<span style="color:red">Error: Unable to connect to AI service.</span>`;
            costBox.textContent = 'N/A';
            timeBox.textContent = 'N/A';
        }
    });

    // Smart Schedule Modal logic
    const scheduleModal = document.getElementById('scheduleModal');
    const slotList = document.getElementById('slotList');
    const chosenSlotDisplay = document.getElementById('chosenSlotDisplay');

    document.getElementById('smartSchedBtn').addEventListener('click', async function () {
        try {
            const resp = await fetch('http://127.0.0.1:5000/smart-schedule');
            const data = await resp.json();

            if (data.available_slots && data.available_slots.length) {
                // populate buttons
                slotList.innerHTML = '';
                selectedSlot = null;
                data.available_slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'slot-btn';
                    btn.textContent = slot;
                    btn.addEventListener('click', ()=> {
                        document.querySelectorAll('.slot-btn').forEach(b=>b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedSlot = slot;
                    });
                    slotList.appendChild(btn);
                });
                scheduleModal.style.display = 'flex';
                scheduleModal.setAttribute('aria-hidden', 'false');
            } else {
                alert('No available slots right now.');
            }
        } catch (err) {
            console.error('Smart schedule error', err);
            alert('Error fetching schedule. Try again later.');
        }
    });

    document.getElementById('closeModalBtn').addEventListener('click', function(){
        scheduleModal.style.display = 'none';
        scheduleModal.setAttribute('aria-hidden', 'true');
    });

    document.getElementById('confirmSlotBtn').addEventListener('click', async function(){
        if (!selectedSlot) { alert('Please select a slot first.'); return; }

        // If we have a created service request (from diagnosis), call /schedule to save the chosen slot there.
        if (currentServiceRequestID) {
            try {
                const resp = await fetch('http://127.0.0.1:5000/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_request_id: currentServiceRequestID,
                        appointment_date: selectedSlot // backend expects a datetime string
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error || 'Failed to schedule');

                chosenSlotDisplay.innerHTML = `✅ Chosen Schedule: <strong>${selectedSlot}</strong>`;
                scheduleModal.style.display = 'none';
                scheduleModal.setAttribute('aria-hidden', 'true');
            } catch (err) {
                console.error(err);
                alert('Failed to save schedule. You can still choose a slot locally.');
            }
        } else {
            // no service request created — just show chosen slot locally
            chosenSlotDisplay.innerHTML = `✅ Chosen Schedule: <strong>${selectedSlot}</strong>`;
            scheduleModal.style.display = 'none';
            scheduleModal.setAttribute('aria-hidden', 'true');
        }
    });

    // Close modal on backdrop click
    window.addEventListener('click', function(e){
        if (e.target === scheduleModal) {
            scheduleModal.style.display = 'none';
            scheduleModal.setAttribute('aria-hidden', 'true');
        }
    });

    // Confirm appointment button
    document.getElementById('confirmBtn').addEventListener('click', function(){
        const productName = document.getElementById('product_name').value.trim();
        const serial = document.getElementById('serial_code').value.trim();
        const purchase = document.getElementById('purchase_date').value;
        const problem = document.getElementById('problemDescription').value.trim();

        if (!productName || !serial || !problem) {
            alert('Please fill in Product Name, Serial Code, and Problem Description.');
            return;
        }

        // If currentServiceRequestID exists, assume record already saved by /diagnose earlier.
        if (currentServiceRequestID) {
            alert('Appointment confirmed — we will email you the details.');
        } else {
            // fallback: you might want to POST a new service_request here if diagnose not used
            alert('Please run Smart Diagnosis first to create the request (recommended).');
        }
    });

    </script>
</body>
</html>